<!DOCTYPE html>
<html lang="en" class="no-js">
{% from 'macros/diagrams.html' import interactive_diagram, diagram_styles, diagram_scripts %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ model.meta.title }} - Threat Model</title>
    <script>document.documentElement.classList.remove('no-js');</script>
    <style>
        :root {
            --green: #28a745;
            --red: #dc3545;
            --yellow: #ffc107;
            --dark: #2c3e50;
            --light-gray: #f8f9fa;
            --border: #dee2e6;
            --sidebar-width: 280px;
            --sidebar-bg: #1a252f;
            --sidebar-text: #ecf0f1;
            --sidebar-hover: #34495e;
            --sidebar-active: #3498db;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #fff;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ========== LEFT SIDEBAR ========== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }
        
        .sidebar-header .subtitle {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 5px;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            padding: 10px 0;
        }
        
        .nav-section {
            margin-bottom: 5px;
        }
        
        .nav-section-header {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }
        
        .nav-section-header:hover {
            background: var(--sidebar-hover);
        }
        
        .nav-section-header.active {
            background: var(--sidebar-active);
        }
        
        .nav-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            transition: transform 0.2s;
        }
        
        .nav-toggle svg {
            width: 12px;
            height: 12px;
            fill: currentColor;
        }
        
        .nav-section.expanded .nav-toggle {
            transform: rotate(90deg);
        }
        
        .nav-section-title {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .nav-section-content {
            display: none;
            background: rgba(0,0,0,0.2);
        }
        
        .nav-section.expanded .nav-section-content {
            display: block;
        }
        
        .nav-item {
            display: block;
            padding: 10px 20px 10px 50px;
            color: #bdc3c7;
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: var(--sidebar-hover);
            color: #fff;
        }
        
        .nav-item.active {
            background: rgba(52, 152, 219, 0.2);
            border-left-color: var(--sidebar-active);
            color: #fff;
        }
        
        /* Sub-items (threats, etc.) */
        .nav-sub-section {
            margin-left: 20px;
        }
        
        .nav-sub-header {
            display: flex;
            align-items: center;
            padding: 8px 20px 8px 30px;
            cursor: pointer;
            font-size: 0.82rem;
            color: #95a5a6;
            transition: color 0.2s;
        }
        
        .nav-sub-header:hover {
            color: #fff;
        }
        
        .nav-sub-toggle {
            width: 16px;
            margin-right: 8px;
            font-size: 0.7rem;
        }
        
        .nav-sub-items {
            display: none;
        }
        
        .nav-sub-section.expanded .nav-sub-items {
            display: block;
        }
        
        .nav-sub-item {
            display: block;
            padding: 6px 20px 6px 58px;
            color: #7f8c8d;
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .nav-sub-item:hover {
            color: #fff;
            background: var(--sidebar-hover);
        }
        
        /* Threat Type Groups */
        .nav-threat-group {
            margin-left: 0;
        }
        
        .nav-threat-group-header {
            display: flex;
            align-items: center;
            padding: 8px 20px 8px 35px;
            cursor: pointer;
            font-size: 0.82rem;
            color: #95a5a6;
            transition: all 0.2s;
            user-select: none;
        }
        
        .nav-threat-group-header:hover {
            color: #fff;
            background: var(--sidebar-hover);
        }
        
        .nav-threat-group.expanded > .nav-threat-group-header {
            color: #fff;
            background: rgba(52, 152, 219, 0.15);
        }
        
        .nav-threat-group-toggle {
            width: 14px;
            height: 14px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .nav-threat-group-toggle svg {
            width: 10px;
            height: 10px;
            fill: currentColor;
        }
        
        .nav-threat-group.expanded .nav-threat-group-toggle {
            transform: rotate(90deg);
        }
        
        .nav-threat-group-title {
            flex: 1;
            font-weight: 500;
        }
        
        .nav-threat-group-count {
            font-size: 0.7rem;
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        .nav-threat-group-items {
            display: none;
            background: rgba(0,0,0,0.15);
        }
        
        .nav-threat-group.expanded .nav-threat-group-items {
            display: block;
        }
        
        .nav-threat-item {
            display: flex;
            align-items: center;
            padding: 6px 20px 6px 50px;
            color: #7f8c8d;
            text-decoration: none;
            font-size: 0.78rem;
            transition: all 0.2s;
            border-left: 2px solid transparent;
        }
        
        .nav-threat-item:hover {
            color: #fff;
            background: var(--sidebar-hover);
        }
        
        .nav-threat-item.active {
            color: #fff;
            border-left-color: var(--sidebar-active);
            background: rgba(52, 152, 219, 0.1);
        }
        
        /* Threat Model Selection */
        .model-list {
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 10px 0;
        }
        
        .model-item-link {
            text-decoration: none;
            color: inherit;
            display: block;
        }
        
        .model-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--sidebar-text);
        }
        
        .model-item:hover {
            background: var(--sidebar-hover);
        }
        
        .model-item.current {
            background: var(--sidebar-active);
            cursor: default;
        }
        
        .model-icon {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .model-item.current .model-icon {
            background: rgba(255,255,255,0.2);
        }
        
        .model-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* ========== MAIN CONTENT ========== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 30px 40px;
            min-height: 100vh;
            max-width: calc(100vw - var(--sidebar-width));
            overflow-x: hidden;
        }
        
        .content-section {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .diagram-section {
            width: 100%;
            overflow: visible;
        }
        
        /* Header */
        .header {
            border-bottom: 3px solid var(--dark);
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2rem;
            color: var(--dark);
        }
        
        .header .meta {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        /* Remove old top nav */
        .nav {
            display: none;
        }
        
        /* Sections */
        section {
            margin-bottom: 40px;
            padding-top: 20px;
        }
        
        section h2 {
            font-size: 1.5rem;
            color: var(--dark);
            border-bottom: 2px solid var(--dark);
            padding-bottom: 8px;
            margin-bottom: 20px;
        }
        
        section h3 {
            font-size: 1.2rem;
            color: #444;
            margin: 25px 0 15px 0;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid var(--border);
        }
        
        th {
            background: var(--dark);
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) { background: var(--light-gray); }
        tr:hover { background: #e9ecef; }
        
        /* Status indicators */
        .status-icon {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .status-mitigated { color: var(--green); }
        .status-unmitigated { color: var(--red); }
        
        .cvss {
            font-family: monospace;
            font-size: 0.85rem;
            background: #eee;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        .cvss-high { background: #f8d7da; color: #721c24; }
        .cvss-medium { background: #fff3cd; color: #856404; }
        .cvss-low { background: #d4edda; color: #155724; }
        
        /* Links */
        a { color: #0066cc; }
        a:hover { color: #004499; }
        
        /* Scope content */
        .scope-text {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--dark);
        }
        
        /* Attack Tree Legend */
        .attack-tree-legend {
            background: var(--light-gray);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px 20px;
            margin-bottom: 15px;
        }
        
        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        
        .legend-edges {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            gap: 30px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }
        
        /* Diagrams */
        .diagram-container {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 40px 20px;
            margin: 15px 0;
            overflow-x: auto;
            overflow-y: visible;
            width: 100%;
            max-width: 100%;
        }
        
        .attack-tree-container {
            min-height: 400px;
        }
        
        .mermaid {
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            width: 100%;
            max-width: 100%;
        }
        
        .mermaid svg {
            max-width: 100%;
            width: auto !important;
            height: auto !important;
            display: block;
            transform-origin: top left;
        }
        
        /* PlantUML Styles */
        .diagram-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .diagram-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 0;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 0.9rem;
            border-radius: 6px 6px 0 0;
            transition: all 0.2s;
            color: #666;
        }
        
        .tab-btn:hover {
            background: #e0e0e0;
        }
        
        .tab-btn.active {
            background: #fff;
            color: var(--dark);
            font-weight: 600;
            border: 2px solid var(--border);
            border-bottom: 2px solid #fff;
            margin-bottom: -2px;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background: #fff;
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 6px 6px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .plantuml-container {
            background: #fff;
            padding: 20px;
            overflow-x: auto;
            text-align: center;
        }
        
        .plantuml-diagram {
            max-width: 100%;
            height: auto;
        }
        
        .puml-source-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .source-tab-btn {
            padding: 8px 15px;
            border: 1px solid var(--border);
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .source-tab-btn.active {
            background: var(--dark);
            color: #fff;
            border-color: var(--dark);
        }
        
        .source-content {
            display: none;
        }
        
        .source-content.active {
            display: block;
        }
        
        .puml-source {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .copy-btn {
            margin-top: 10px;
            padding: 8px 16px;
            background: var(--sidebar-active);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .copy-btn:hover {
            background: #2980b9;
        }
        
        .puml-legend {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        
        .puml-legend h4 {
            margin: 0 0 10px 0;
            font-size: 0.95rem;
            color: var(--dark);
        }
        
        .puml-legend .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .puml-legend .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .puml-legend .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .puml-legend .legend-color.critical { background: #FF6B6B; }
        .puml-legend .legend-color.high { background: #FFA500; }
        .puml-legend .legend-color.medium { background: #FFD93D; }
        .puml-legend .legend-color.low { background: #6BCB77; }
        
        .puml-legend .legend-arrow {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .puml-legend .legend-arrow.red { color: #FF0000; }
        .puml-legend .legend-arrow.orange { color: #FFA500; }
        
        /* Threat Cards */
        .threat-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 40px;
            overflow: hidden;
            transition: box-shadow 0.3s ease, border-color 0.3s ease;
        }
        
        .threat-card.highlight {
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
            border-color: var(--sidebar-active);
        }
        
        @keyframes highlight-pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(52, 152, 219, 0.3); }
            50% { box-shadow: 0 0 25px rgba(52, 152, 219, 0.6); }
        }
        
        .threat-card.highlight {
            animation: highlight-pulse 0.5s ease-in-out 3;
        }
        
        .threat-card-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .threat-card-header h4 {
            margin: 0;
            font-size: 1.3rem;
            color: #333;
        }
        
        .threat-card-header .threat-id {
            color: var(--red);
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .threat-card-body {
            display: flex;
            gap: 30px;
            padding: 20px;
        }
        
        .threat-details {
            flex: 1;
            min-width: 0;
        }
        
        .threat-diagram {
            width: 400px;
            flex-shrink: 0;
        }
        
        /* Detail rows */
        .detail-row {
            margin-bottom: 15px;
        }
        
        .detail-label {
            font-weight: 600;
            color: #555;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 0.95rem;
        }
        
        .detail-value.mitigated {
            color: var(--green);
            font-weight: 600;
        }
        
        .detail-value.unmitigated {
            color: var(--red);
            font-weight: 600;
        }
        
        /* Security objective tags */
        .sec-obj-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        
        .sec-obj-tag {
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-family: monospace;
            border-radius: 3px;
        }
        
        /* CVSS section */
        .cvss-section {
            background: var(--light-gray);
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .cvss-score {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .cvss-vector {
            font-family: monospace;
            font-size: 0.8rem;
            color: #666;
            word-break: break-all;
        }
        
        /* Countermeasures section */
        .cm-section {
            margin-top: 25px;
            border-top: 2px solid var(--dark);
            padding-top: 15px;
        }
        
        .cm-section h5 {
            font-size: 1rem;
            color: var(--dark);
            margin-bottom: 15px;
        }
        
        .cm-item {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 12px;
        }
        
        .cm-item.implemented {
            border-left: 4px solid var(--green);
        }
        
        .cm-item.not-implemented {
            border-left: 4px solid var(--yellow);
        }
        
        .cm-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .cm-id {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--red);
            background: #fff0f0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        .cm-title {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .cm-desc {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .cm-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .cm-status-label {
            color: #666;
        }
        
        .cm-status-value {
            font-weight: 600;
        }
        
        .cm-status-value.yes {
            color: var(--green);
        }
        
        .cm-status-value.no {
            color: var(--red);
        }
        
        /* Visual diagram styles */
        .visual-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .vt-node {
            text-align: center;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 0.85rem;
            max-width: 350px;
        }
        
        .vt-threat {
            background: #fff;
            border: 2px solid var(--red);
        }
        
        .vt-threat-title {
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .vt-threat .sec-obj-tags {
            justify-content: center;
        }
        
        .vt-attack {
            background: #fff5f5;
            border: 1px solid #f5c6cb;
        }
        
        .vt-attack-label {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--red);
            margin-bottom: 5px;
        }
        
        .vt-connector {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 0;
        }
        
        .vt-line {
            width: 2px;
            height: 20px;
            background: #999;
        }
        
        .vt-label {
            font-size: 0.75rem;
            color: #666;
            font-style: italic;
        }
        
        /* Countermeasures row */
        .vt-cm-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 5px;
        }
        
        .vt-cm {
            background: #e8f5e9;
            border: 1px solid var(--green);
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
            min-width: 120px;
        }
        
        .vt-cm.not-impl {
            background: #fff8e1;
            border-color: var(--yellow);
        }
        
        .vt-cm-label {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 3px;
        }
        
        .vt-cm-title {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Mitigates connector for multiple CMs */
        .vt-mitigates-row {
            display: flex;
            justify-content: center;
            gap: 10px;
            position: relative;
        }
        
        .vt-mitigates-row::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: #999;
        }
        
        .vt-mitigate-line {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .vt-mitigate-line .vt-line {
            height: 15px;
        }
        
        @media (max-width: 1100px) {
            .sidebar {
                width: 240px;
            }
            :root {
                --sidebar-width: 240px;
            }
            .threat-card-body {
                flex-direction: column;
            }
            .threat-diagram {
                width: 100%;
            }
        }
        
        @media (max-width: 900px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
            }
            .main-content {
                margin-left: 0;
            }
            body {
                flex-direction: column;
            }
        }
        
        /* Footer */
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            text-align: center;
            color: #666;
            font-size: 0.85rem;
        }
        
        /* Affected Assets badges in threat cards */
        .affected-assets {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 5px;
        }
        
        .affected-asset-badge {
            background: #e3f2fd;
            color: #1565c0;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid #90caf9;
        }
        
        /* ========== ASSET SECTION STYLES ========== */
        .asset-section {
            border-left: 4px solid #3498db;
            padding-left: 20px;
            margin-bottom: 50px;
        }
        
        .asset-section h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .asset-icon {
            font-size: 1.3rem;
        }
        
        .asset-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .asset-type-badge {
            background: #3498db;
            color: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .asset-zone-badge {
            background: #9b59b6;
            color: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .asset-threat-count {
            background: var(--light-gray);
            color: #666;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid var(--border);
        }
        
        .asset-description {
            background: var(--light-gray);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #555;
        }
        
        .asset-threats-table {
            width: 100%;
            margin-top: 15px;
        }
        
        .asset-threats-table tbody tr:hover {
            background: #e3f2fd !important;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-badge.mitigated {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.unmitigated {
            background: #f8d7da;
            color: #721c24;
        }
        
        .no-threats-message {
            color: #666;
            font-style: italic;
            padding: 20px;
            text-align: center;
            background: var(--light-gray);
            border-radius: 6px;
        }
        
        .cvss-critical {
            background: #8B0000 !important;
            color: #fff !important;
        }
        
        /* ========== SECURITY TESTING STYLES ========== */
        .testing-section {
            border-left: 4px solid #9c27b0;
            padding-left: 20px;
            margin-bottom: 50px;
        }
        
        .testing-section h2 {
            color: #7b1fa2;
        }
        
        .testing-intro {
            background: #f3e5f5;
            border: 1px solid #e1bee7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .test-case-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .test-case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #fafafa;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        
        .test-case-header:hover {
            background: #f0f0f0;
        }
        
        .test-case-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-case-title h4 {
            margin: 0;
            font-size: 1rem;
        }
        
        .test-case-id {
            font-family: monospace;
            font-size: 0.8rem;
            background: #9c27b0;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .test-status-select {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .test-status-select.not-tested { background: #f5f5f5; }
        .test-status-select.passed { background: #c8e6c9; color: #2e7d32; }
        .test-status-select.failed { background: #ffcdd2; color: #c62828; }
        .test-status-select.in-progress { background: #fff9c4; color: #f57f17; }
        
        .test-case-body {
            padding: 20px;
        }
        
        .test-objective {
            margin-bottom: 15px;
        }
        
        .test-objective-label {
            font-weight: 600;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .test-steps {
            background: #fafafa;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .test-steps h5 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: #333;
        }
        
        .test-steps ol {
            margin: 0;
            padding-left: 20px;
        }
        
        .test-steps li {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .test-expected {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .test-expected h5 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            color: #2e7d32;
        }
        
        .test-tools {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .test-tool-tag {
            background: #e1bee7;
            color: #7b1fa2;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .test-notes {
            margin-top: 15px;
        }
        
        .test-notes textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }
        
        .test-prerequisites {
            background: #fff3e0;
            border: 1px solid #ffe0b2;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .test-prerequisites h5 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            color: #e65100;
        }
        
        .test-prerequisites ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .test-script {
            background: #263238;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .test-script-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .test-script-language {
            color: #4fc3f7;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .test-script-copy {
            background: #37474f;
            color: #fff;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background 0.2s;
        }
        
        .test-script-copy:hover {
            background: #455a64;
        }
        
        .test-script-copy.copied {
            background: #4caf50;
        }
        
        .test-script-description {
            color: #90a4ae;
            font-size: 0.85rem;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .test-script pre {
            margin: 0;
            padding: 0;
            background: transparent;
            overflow-x: auto;
        }
        
        .test-script code {
            color: #b0bec5;
            font-family: 'Courier New', Consolas, Monaco, monospace;
            font-size: 0.85rem;
            line-height: 1.5;
        }
        
        .test-script-requirements {
            color: #78909c;
            font-size: 0.8rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #37474f;
        }
        
        .test-behavior {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .test-behavior-vulnerable,
        .test-behavior-mitigated {
            border-radius: 6px;
            padding: 15px;
        }
        
        .test-behavior-vulnerable {
            background: #ffebee;
            border: 1px solid #ffcdd2;
        }
        
        .test-behavior-vulnerable h5 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            color: #c62828;
        }
        
        .test-behavior-mitigated {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
        }
        
        .test-behavior-mitigated h5 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            color: #2e7d32;
        }
        
        .testing-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .testing-stat {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .testing-stat-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .testing-stat-label {
            font-size: 0.85rem;
            color: #666;
        }
        
        .testing-stat.total .testing-stat-value { color: #333; }
        .testing-stat.passed .testing-stat-value { color: #2e7d32; }
        .testing-stat.failed .testing-stat-value { color: #c62828; }
        .testing-stat.pending .testing-stat-value { color: #f57f17; }

        /* Static diagram container for simple non-interactive diagrams */
        .static-diagram {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
            overflow-x: auto;
        }
        
        .static-diagram .mermaid {
            display: flex;
            justify-content: center;
        }
        
        .static-diagram .mermaid svg {
            max-width: 100%;
            height: auto;
        }

        /* Print Mode Toggle Button */
        .print-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--dark);
            color: #fff;
            padding: 12px 18px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: none;
        }
        
        .print-mode-toggle:hover {
            background: #1a252f;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .print-mode-toggle svg {
            width: 18px;
            height: 18px;
        }
        
        .print-mode-toggle.active {
            background: var(--green);
        }
        
        .print-mode-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--green);
            color: #fff;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 10000;
            display: none;
        }
        
        .print-mode-indicator .print-actions {
            margin-left: 20px;
        }
        
        .print-mode-indicator button {
            background: #fff;
            color: var(--green);
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .print-mode-indicator button:hover {
            background: #f0f0f0;
        }
        
        .print-mode-indicator button.exit-btn {
            background: transparent;
            color: #fff;
            border: 1px solid #fff;
        }
        
        /* ========== PRINT/PDF MODE STYLES ========== */
        body.print-mode {
            display: block;
        }
        
        body.print-mode .sidebar {
            display: none !important;
        }
        
        body.print-mode .main-content {
            margin-left: 0 !important;
            max-width: 100% !important;
            padding: 20px 40px;
        }
        
        body.print-mode .print-mode-toggle {
            display: none;
        }
        
        body.print-mode .print-mode-indicator {
            display: block;
        }
        
        /* Expand all collapsible sections in print mode */
        body.print-mode .nav-section,
        body.print-mode .nav-threat-group,
        body.print-mode .nav-sub-section {
            display: block !important;
        }
        
        body.print-mode .nav-section-content,
        body.print-mode .nav-threat-group-items,
        body.print-mode .nav-sub-items {
            display: block !important;
        }
        
        /* Hide interactive controls in print mode */
        body.print-mode .diagram-toolbar {
            display: none !important;
        }
        
        body.print-mode .diagram-hint {
            display: none !important;
        }
        
        body.print-mode .toolbar-btn {
            display: none !important;
        }
        
        body.print-mode .fullscreen-close {
            display: none !important;
        }
        
        body.print-mode .tab-btn {
            pointer-events: none;
        }
        
        /* Show all tab contents in print mode */
        body.print-mode .tab-content {
            display: block !important;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            page-break-inside: avoid;
            page-break-before: always;
        }
        
        body.print-mode .tab-content::before {
            content: attr(data-tab-name);
            display: block;
            font-weight: 600;
            padding: 10px 15px;
            background: var(--light-gray);
            border-bottom: 1px solid var(--border);
        }
        
        body.print-mode .diagram-tabs {
            display: none;
        }
        
        /* Hide UML source code in print mode */
        body.print-mode .tab-content#puml-source {
            display: none !important;
        }
        
        /* Ensure diagrams are visible and static in print mode */
        body.print-mode .interactive-diagram {
            page-break-inside: avoid;
            margin: 0 auto;
        }
        
        body.print-mode .diagram-viewport {
            overflow: visible !important;
            max-height: none !important;
            cursor: default !important;
            border: none;
        }
        
        body.print-mode .diagram-canvas {
            transform: none !important;
            display: flex;
            justify-content: center;
        }
        
        /* Full width for diagrams in print mode */
        body.print-mode .mermaid svg {
            max-width: 100% !important;
            height: auto !important;
        }
        
        /* Ensure PlantUML images are visible and fit for print */
        body.print-mode .plantuml-diagram {
            max-width: 100% !important;
            max-height: 95vh !important; /* Force fit to page height */
            width: auto !important;
            height: auto !important;
            display: block;
            margin: 0 auto;
        }
        
        /* Larger viewport for PlantUML diagrams in print mode */
        body.print-mode .diagram-viewport {
            min-height: auto !important;
        }
        
        /* Page breaks for PDF generation */
        body.print-mode section {
            page-break-inside: avoid;
        }
        
        body.print-mode .threat-card {
            page-break-inside: avoid;
            margin-bottom: 30px;
        }
        
        body.print-mode h2 {
            page-break-after: avoid;
        }
        
        body.print-mode h3 {
            page-break-after: avoid;
        }
        
        body.print-mode table {
            page-break-inside: avoid;
        }
        
        /* Print mode for Testing section */
        body.print-mode .testing-section {
            page-break-before: always;
        }
        
        body.print-mode .test-case-card {
            page-break-inside: avoid;
            margin-bottom: 20px;
        }
        
        body.print-mode .test-case-body {
            display: block !important;
        }
        
        body.print-mode .test-status-select {
            display: none;
        }
        
        body.print-mode .testing-summary {
            display: none;
        }
        
        body.print-mode .test-notes {
            display: none;
        }
        
        body.print-mode .review-checklist input[type="checkbox"] {
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
        }

        /* Print styles for actual printing */
        @media print {
            .sidebar { display: none !important; }
            .main-content { margin-left: 0 !important; }
            body { display: block !important; }
            section { page-break-inside: avoid; }
            .print-mode-toggle { display: none !important; }
            .print-mode-indicator { display: none !important; }
            .diagram-toolbar { display: none !important; }
            .diagram-hint { display: none !important; }
            .toolbar-btn { display: none !important; }
            .fullscreen-close { display: none !important; }
            .tab-btn { display: none !important; }
            .tab-content { 
                display: block !important;
                page-break-inside: avoid;
            }
            .tab-content#puml-source {
                display: none !important;
            }
            .diagram-tabs { display: none !important; }
            .diagram-viewport {
                overflow: visible !important;
                max-height: none !important;
            }
            .diagram-canvas {
                transform: none !important;
            }
            .threat-card {
                page-break-inside: avoid;
            }
            .interactive-diagram {
                page-break-inside: avoid;
            }
        }
        
        {{ diagram_styles() }}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
</head>
<body>

    <!-- Print Mode Indicator Banner -->
    <div class="print-mode-indicator" id="printModeIndicator">
        <span>üìÑ Print/PDF Mode Active - All sections expanded, interactive features disabled</span>
        <span class="print-actions">
            <button onclick="window.print()" title="Print or Save as PDF">üñ®Ô∏è Print / Save PDF</button>
            <button class="exit-btn" onclick="togglePrintMode()">‚úï Exit Print Mode</button>
        </span>
    </div>

    <!-- Print Mode Toggle Button -->
    <button class="print-mode-toggle" id="printModeToggle" onclick="togglePrintMode()" title="Toggle Print/PDF Mode">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6,9 6,2 18,2 18,9"></polyline>
            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
            <rect x="6" y="14" width="12" height="8"></rect>
        </svg>
        <span>Print Mode</span>
    </button>

    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>Threat Models</h2>
            <div class="subtitle">Security Analysis Platform</div>
        </div>
        
        <!-- Threat Model List -->
        <div class="model-list">
            {% if all_models %}
                {% for tm in all_models %}
                {% if tm.isCurrent %}
                <div class="model-item current">
                    <div class="model-icon">TM</div>
                    <div class="model-name">{{ tm.title }}</div>
                </div>
                {% else %}
                <a href="{{ tm.path }}" class="model-item-link">
                    <div class="model-item">
                        <div class="model-icon">TM</div>
                        <div class="model-name">{{ tm.title }}</div>
                    </div>
                </a>
                {% endif %}
                {% endfor %}
            {% else %}
            <div class="model-item current">
                <div class="model-icon">TM</div>
                <div class="model-name">{{ model.meta.title }}</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Current Model Navigation -->
        <nav class="sidebar-nav">
            <!-- Summary Section -->
            <div class="nav-section expanded">
                <div class="nav-section-header" onclick="toggleSection(this)">
                    <span class="nav-toggle">
                        <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                    </span>
                    <span class="nav-section-title">Overview</span>
                </div>
                <div class="nav-section-content">
                    <a href="#summary" class="nav-item">Summary</a>
                    <a href="#threat-summary" class="nav-item">Threat Summary</a>
                </div>
            </div>
            
            <!-- Scope Section -->
            <div class="nav-section expanded">
                <div class="nav-section-header" onclick="toggleSection(this)">
                    <span class="nav-toggle">
                        <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                    </span>
                    <span class="nav-section-title">Scope & Analysis</span>
                </div>
                <div class="nav-section-content">
                    <a href="#scope" class="nav-item">Scope</a>
                    <a href="#analysis" class="nav-item">Analysis</a>
                    <a href="#attack-tree" class="nav-item">Attack Tree</a>
                    {% if has_data_flows %}<a href="#dfd" class="nav-item">Data Flow Diagram</a>{% endif %}
                    {% if has_data_flows %}<a href="#puml-dfd" class="nav-item">PlantUML Risk View</a>{% endif %}
                </div>
            </div>
            
            <!-- Assets Section -->
            <div class="nav-section expanded">
                <div class="nav-section-header" onclick="toggleSection(this)">
                    <span class="nav-toggle">
                        <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                    </span>
                    <span class="nav-section-title">Assets ({{ model.assets | length }})</span>
                </div>
            </div>
            
            <!-- Threats Section -->
            <div class="nav-section expanded">
                <div class="nav-section-header" onclick="toggleSection(this)">
                    <span class="nav-toggle">
                        <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                    </span>
                    <span class="nav-section-title">Threats ({{ model.threats | length }})</span>
                </div>
                <div class="nav-section-content">
                    {% set threat_types = {} %}
                    {% for threat in model.threats %}
                        {% if threat.threatType not in threat_types %}
                            {% set _ = threat_types.update({threat.threatType: []}) %}
                        {% endif %}
                        {% set _ = threat_types[threat.threatType].append(threat) %}
                    {% endfor %}
                    {% for threat_type, threats in threat_types.items() %}
                    <div class="nav-threat-group" data-threat-group="{{ threat_type }}">
                        <div class="nav-threat-group-header" onclick="toggleThreatGroup(this)">
                            <span class="nav-threat-group-toggle">
                                <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                            </span>
                            <span class="nav-threat-group-title">{{ threat_type }}</span>
                            <span class="nav-threat-group-count">{{ threats | length }}</span>
                        </div>
                        <div class="nav-threat-group-items">
                            {% for threat in threats %}
                            <a href="#threat-{{ threat.ID }}" class="nav-threat-item">
                                {% if threat.CVSS and threat.CVSS.score %}
                                <span class="cvss {% if threat.CVSS.score >= 7.0 %}cvss-high{% elif threat.CVSS.score >= 4.0 %}cvss-medium{% else %}cvss-low{% endif %}" style="font-size: 0.65rem; margin-right: 5px;">{{ threat.CVSS.score }}</span>
                                {% endif %}
                                {{ threat.title | truncate(25) }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Security Testing Section -->
            <div class="nav-section">
                <div class="nav-section-header" onclick="toggleSection(this)">
                    <span class="nav-toggle">
                        <svg viewBox="0 0 24 24"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                    </span>
                    <span class="nav-section-title" style="color: #9c27b0;">üß™ Security Testing</span>
                </div>
                <div class="nav-section-content">
                    <a href="#security-testing" class="nav-item">Test Cases ({{ model.threats | length }})</a>
                </div>
            </div>
        </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <h1>{{ model.meta.title }}</h1>
            <div class="meta">
                Model ID: {{ model.meta.modelId }} | Version: {{ model.meta.version }} | Generated: {{ generation_timestamp }}
            </div>
        </header>

    <!-- Summary Section -->
    <section id="summary">
        <h2>Summary</h2>
        <p style="margin-bottom: 15px;">
            <strong>{{ unmitigated_threats | length }}</strong> unmitigated threats requiring attention:
        </p>
        
        {% if unmitigated_threats %}
        <table>
            <thead>
                <tr>
                    <th>Threat ID</th>
                    <th>Title</th>
                    <th>CVSS Score</th>
                    <th>Type</th>
                    <th style="width: 120px; text-align: center;">Always Present</th>
                </tr>
            </thead>
            <tbody>
                {% for threat in unmitigated_threats %}
                <tr>
                    <td><a href="#threat-{{ threat.ID }}">{{ threat.ID }}</a></td>
                    <td>{{ threat.title }}</td>
                    <td>
                        <span class="cvss {% if threat.cvss_score >= 7.0 %}cvss-high{% elif threat.cvss_score >= 4.0 %}cvss-medium{% else %}cvss-low{% endif %}">
                            {{ "%.1f"|format(threat.cvss_score) }}
                        </span>
                    </td>
                    <td>{{ threat.threatType }}</td>
                    <td style="text-align: center;">
                        {% if threat.alwaysPresent %}
                        <span style="color: var(--orange); font-weight: 600;">TRUE</span>
                        {% else %}
                        <span style="color: var(--text-muted); font-weight: 500;">FALSE</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: var(--green); font-weight: 500;">‚úì All threats are fully mitigated.</p>
        {% endif %}
    </section>

    <!-- Threat Summary Section -->
    <section id="threat-summary">
        <h2>Threat Summary</h2>
        <table>
            <thead>
                <tr>
                    <th>Threat</th>
                    <th style="width: 100px; text-align: center;">Mitigated</th>
                    <th style="width: 120px; text-align: center;">Always Present</th>
                    <th style="width: 180px; text-align: center;">Countermeasures Operational</th>
                </tr>
            </thead>
            <tbody>
                {% for threat in model.threats %}
                <tr>
                    <td><a href="#threat-{{ threat.ID }}">{{ threat.title }}</a></td>
                    <td style="text-align: center;">
                        {% if threat.fullyMitigated %}
                        <span class="status-icon status-mitigated">‚úì</span>
                        {% else %}
                        <span class="status-icon status-unmitigated">‚úó</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if threat.alwaysPresent %}
                        <span style="color: var(--orange); font-weight: 600;">TRUE</span>
                        {% else %}
                        <span style="color: var(--text-muted); font-weight: 500;">FALSE</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% set operational = threat.countermeasures | selectattr('status', 'equalto', 'in_place') | list | length %}
                        {% set total = threat.countermeasures | length %}
                        {% if operational == total and total > 0 %}
                        <span style="color: var(--green); font-weight: 600;">TRUE</span>
                        {% else %}
                        <span style="color: var(--red); font-weight: 600;">FALSE</span>
                        <span style="color: #666; font-size: 0.85rem;">({{ operational }}/{{ total }})</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>

    <!-- Scope Section -->
    <section id="scope">
        <h2>Scope</h2>
        <div class="scope-text">
            {{ model.meta.scope }}
        </div>

        <!-- Analysis -->
        <h3 id="analysis">Analysis</h3>
        <table>
            <tr>
                <th style="width: 200px;">Total Assets</th>
                <td>{{ model.assets | length }}</td>
            </tr>
            <tr>
                <th>Total Threats</th>
                <td>{{ model.threats | length }}</td>
            </tr>
            <tr>
                <th>Mitigated Threats</th>
                <td>{{ mitigated_count }} / {{ model.threats | length }}</td>
            </tr>
            <tr>
                <th>Total Countermeasures</th>
                <td>{{ countermeasure_count }}</td>
            </tr>
            <tr>
                <th>Operational Countermeasures</th>
                <td>{{ cm_in_place }} / {{ countermeasure_count }}</td>
            </tr>
            <tr>
                <th>Attackers Considered</th>
                <td>{{ model.attackers | map(attribute='name') | join(', ') }}</td>
            </tr>
        </table>

        {% if model.assets %}
        <h4 style="margin: 20px 0 10px 0;">Assets Identified</h4>
        <table>
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Type</th>
                    <th>Trust Zone</th>
                </tr>
            </thead>
            <tbody>
                {% for asset in model.assets %}
                <tr>
                    <td>{{ asset.name }}</td>
                    <td>{{ asset.type }}</td>
                    <td>{{ asset.trustZone or 'internal' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        <!-- Attack Tree -->
        <h3 id="attack-tree">Attack Tree</h3>
        {% if model.threats %}
        
        <!-- Attack Tree Legend -->
        <div class="attack-tree-legend">
            <div class="legend-title">Legend:</div>
            <div class="legend-items">
                <div class="legend-item">
                    <span class="legend-color" style="background: #2c3e50;"></span>
                    <span>Threat Model (Root)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #3498db;"></span>
                    <span>Assets</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #e74c3c;"></span>
                    <span>Threats - Critical/High CVSS</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #f39c12;"></span>
                    <span>Threats - Medium CVSS</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #27ae60;"></span>
                    <span>Mitigations - In Place</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background: #bdc3c7;"></span>
                    <span>Mitigations - Planned</span>
                </div>
            </div>
            <div class="legend-edges">
                <span><strong>Flow:</strong> Threat Model ‚Üí Assets ‚Üí Threats ‚Üí Mitigations</span>
                <span><strong>‚Üí impacts</strong> = Asset has threat</span>
                <span><strong>‚Üí mitigates</strong> = Control mitigates threat</span>
            </div>
        </div>
        
        {{ attack_tree_html }}
        {% else %}
        <p>No threats defined.</p>
        {% endif %}

        <!-- Data Flow Diagram -->
        {% if has_data_flows %}
        <h3 id="dfd">Data Flow Diagrams</h3>
        <p class="diagram-description">This section includes PlantUML component view, sequence view, and UML source.</p>
        
        <div class="diagram-tabs">
            <button class="tab-btn active" data-tab="puml-component">Component View</button>
            <button class="tab-btn" data-tab="puml-sequence">Sequence View</button>
            <button class="tab-btn" data-tab="puml-source">UML Source</button>
        </div>
        
        <div class="tab-content active" id="puml-component" data-tab-name="Component View (PlantUML)">
            {{ interactive_diagram(
                diagram_type='plantuml-component',
                diagram_title='PlantUML Component Diagram',
                content_type='plantuml-img',
                content='',
                diagram_id='puml-component-img'
            ) }}
        </div>
        
        <div class="tab-content" id="puml-sequence" data-tab-name="Sequence View (PlantUML)">
            {{ interactive_diagram(
                diagram_type='plantuml-sequence',
                diagram_title='PlantUML Sequence Diagram',
                content_type='plantuml-img',
                content='',
                diagram_id='puml-sequence-img'
            ) }}
        </div>
        
        <div class="tab-content" id="puml-source" data-tab-name="UML Source Code">
            <div class="puml-source-tabs">
                <button class="source-tab-btn active" data-source="component">Component PUML</button>
                <button class="source-tab-btn" data-source="sequence">Sequence PUML</button>
            </div>
            <div class="source-content active" id="source-component">
                <pre class="puml-source"><code>{{ dfd_plantuml }}</code></pre>
                <button class="copy-btn" onclick="copyPumlSource('component')">Copy PlantUML</button>
            </div>
            <div class="source-content" id="source-sequence">
                <pre class="puml-source"><code>{{ dfd_plantuml_sequence }}</code></pre>
                <button class="copy-btn" onclick="copyPumlSource('sequence')">Copy PlantUML</button>
            </div>
        </div>
        
        <div class="puml-legend">
            <h4>Risk Color Legend</h4>
            <div class="legend-items">
                <div class="legend-item"><span class="legend-color critical"></span> Critical Risk (CVSS 9.0+)</div>
                <div class="legend-item"><span class="legend-color high"></span> High Risk (CVSS 7.0-8.9)</div>
                <div class="legend-item"><span class="legend-color medium"></span> Medium Risk (CVSS 4.0-6.9)</div>
                <div class="legend-item"><span class="legend-color low"></span> Low Risk (CVSS &lt; 4.0)</div>
            </div>
            <div class="legend-items">
                <div class="legend-item"><span class="legend-arrow red">‚Üí</span> Crosses Trust Boundary</div>
                <div class="legend-item"><span class="legend-arrow orange">‚Üí</span> Sensitive Data Flow</div>
            </div>
        </div>
        {% endif %}
    </section>

    <!-- Threats Section -->
    <section id="threats">
        <h2>Threats</h2>
        
        {% for threat in model.threats %}
        <div id="threat-{{ threat.ID }}" class="threat-card">
            <div class="threat-card-header">
                <h4>{{ threat.title }} <span class="threat-id">( {{ threat.ID }} )</span></h4>
            </div>
            <div class="threat-card-body">
                
                <!-- Left side: Details -->
                <div class="threat-details">
                    <div class="detail-row">
                        <div class="detail-label">Threat Status:</div>
                        <div class="detail-value {% if threat.fullyMitigated %}mitigated{% else %}unmitigated{% endif %}">
                            {% if threat.fullyMitigated %}Mitigated{% else %}Unmitigated{% endif %}
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">Threat Description</div>
                        <div class="detail-value">{{ threat.attack }}</div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">Impact</div>
                        <div class="detail-value">
                            <ul style="margin: 5px 0 0 20px; padding: 0;">
                                {% for impact in threat.impactDesc.split(',') %}
                                <li>{{ impact | trim }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="detail-row">
                        <div class="detail-label">Security Objectives</div>
                        <div class="sec-obj-tags">
                            {% for obj in threat.impactedSecObj %}
                            <span class="sec-obj-tag">{{ obj }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    {% if threat_assets_map.get(threat.ID) %}
                    <div class="detail-row">
                        <div class="detail-label">Affected Assets</div>
                        <div class="affected-assets">
                            {% for asset in threat_assets_map.get(threat.ID, []) %}
                            <span class="affected-asset-badge">{{ asset.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if threat.CVSS %}
                    <div class="cvss-section">
                        <div class="detail-label">CVSS</div>
                        <div class="cvss-score">
                            Base Score: <strong>{{ threat.CVSS.score }}</strong>
                            <span class="cvss {% if threat.CVSS.score >= 9.0 %}cvss-high{% elif threat.CVSS.score >= 7.0 %}cvss-high{% elif threat.CVSS.score >= 4.0 %}cvss-medium{% else %}cvss-low{% endif %}" style="margin-left: 8px; padding: 2px 8px; border-radius: 4px;">
                                {{ threat.CVSS.severity }}
                            </span>
                        </div>
                        <div class="cvss-vector">Vector: <code>{{ threat.CVSS.vector }}</code></div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Right side: Visual diagram -->
                <div class="threat-diagram">
                    <div class="visual-tree">
                        <!-- Threat Node -->
                        <div class="vt-node vt-threat">
                            <div style="font-size: 0.75rem; color: #666; margin-bottom: 5px;">Threat</div>
                            <div class="vt-threat-title">{{ threat.title }}</div>
                            <div class="sec-obj-tags">
                                {% for obj in threat.impactedSecObj %}
                                <span class="sec-obj-tag" style="color: var(--red); border-color: var(--red);">{{ obj }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Connector: exploits -->
                        <div class="vt-connector">
                            <div class="vt-line"></div>
                            <div class="vt-label">exploits</div>
                            <div class="vt-line"></div>
                        </div>
                        
                        <!-- Attack Node -->
                        <div class="vt-node vt-attack">
                            <div class="vt-attack-label">Attack</div>
                            <div>{{ threat.attack }}</div>
                        </div>
                        
                        <!-- Connector: mitigates -->
                        <div class="vt-connector">
                            <div class="vt-line"></div>
                            <div class="vt-label">mitigates</div>
                        </div>
                        
                        <!-- Countermeasures row -->
                        <div class="vt-cm-row">
                            {% for cm in threat.countermeasures %}
                            <div class="vt-cm {% if cm.status != 'in_place' %}not-impl{% endif %}">
                                <div class="vt-cm-label">Countermeasure</div>
                                <div class="vt-cm-title">{{ cm.title }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Countermeasures detailed section -->
            <div class="cm-section" style="margin: 0 20px 20px 20px;">
                <h5>Counter-measures for {{ threat.ID }}</h5>
                
                {% for cm in threat.countermeasures %}
                <div class="cm-item {% if cm.status == 'in_place' %}implemented{% else %}not-implemented{% endif %}">
                    <div class="cm-header">
                        <div>
                            <span class="cm-id">{{ cm.ID }}</span>
                            <span class="cm-title">{{ cm.title }}</span>
                        </div>
                    </div>
                    <div class="cm-desc">{{ cm.description }}</div>
                    <div class="cm-status">
                        <span class="cm-status-label">Countermeasure in place?</span>
                        <span class="cm-status-value {% if cm.status == 'in_place' %}yes{% else %}no{% endif %}">
                            {% if cm.status == 'in_place' %}‚úì{% else %}‚úó{% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </section>

    <!-- Security Testing Section -->
    <section id="security-testing" class="testing-section">
        <h2>
            <span class="asset-icon">üß™</span>
            Security Testing
        </h2>
        
        <div class="testing-intro">
            <p><strong>Purpose:</strong> This section provides security test cases derived from the identified threats. 
            Use these test cases during penetration testing and security assessments to validate that threats have been 
            properly mitigated and security controls are effective.</p>
        </div>
        
        <!-- Testing Progress Summary -->
        <div class="testing-summary no-print">
            <div class="testing-stat total">
                <div class="testing-stat-value" id="test-total">{{ model.threats | length }}</div>
                <div class="testing-stat-label">Total Tests</div>
            </div>
            <div class="testing-stat passed">
                <div class="testing-stat-value" id="test-passed">0</div>
                <div class="testing-stat-label">Passed</div>
            </div>
            <div class="testing-stat failed">
                <div class="testing-stat-value" id="test-failed">0</div>
                <div class="testing-stat-label">Failed</div>
            </div>
            <div class="testing-stat pending">
                <div class="testing-stat-value" id="test-pending">{{ model.threats | length }}</div>
                <div class="testing-stat-label">Not Tested</div>
            </div>
        </div>
        
        <!-- Test Cases Generated from Threats -->
        {% for threat in model.threats %}
        <div class="test-case-card" id="test-{{ threat.ID }}" data-test-status="not-tested">
            <div class="test-case-header" onclick="toggleTestCase(this)">
                <div class="test-case-title">
                    <span class="test-case-id">TC-{{ threat.ID }}</span>
                    <h4>{{ threat.title }}</h4>
                </div>
                <select class="test-status-select not-tested no-print" onchange="updateTestStatus(this, '{{ threat.ID }}')" onclick="event.stopPropagation()">
                    <option value="not-tested">‚è∏ Not Tested</option>
                    <option value="in-progress">üîÑ In Progress</option>
                    <option value="passed">‚úÖ Passed</option>
                    <option value="failed">‚ùå Failed</option>
                </select>
            </div>
            <div class="test-case-body" style="display: none;">
                <div class="test-objective">
                    <div class="test-objective-label">Test Objective</div>
                    <p>Verify that the system is protected against: <strong>{{ threat.attack }}</strong></p>
                </div>
                
                {% if threat.testPrerequisites %}
                <div class="test-prerequisites">
                    <h5>‚öôÔ∏è Prerequisites</h5>
                    <ul>
                        {% for prereq in threat.testPrerequisites %}
                        <li>{{ prereq }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% if threat.expectedBehavior or threat.expectedMitigation %}
                <div class="test-behavior">
                    {% if threat.expectedBehavior %}
                    <div class="test-behavior-vulnerable">
                        <h5>üö® Vulnerable Behavior</h5>
                        <p style="margin: 0; font-size: 0.9rem;">{{ threat.expectedBehavior }}</p>
                    </div>
                    {% endif %}
                    {% if threat.expectedMitigation %}
                    <div class="test-behavior-mitigated">
                        <h5>‚úÖ Expected When Mitigated</h5>
                        <p style="margin: 0; font-size: 0.9rem;">{{ threat.expectedMitigation }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                <div class="test-steps">
                    <h5>üìã Detailed Replication Steps</h5>
                    {% if threat.testSteps %}
                    <ol>
                        {% for step in threat.testSteps %}
                        <li>{{ step }}</li>
                        {% endfor %}
                    </ol>
                    {% else %}
                    <ol>
                        {% if 'Spoofing' in threat.impactedSecObj %}
                        <li>Attempt to authenticate using forged or invalid credentials</li>
                        <li>Test for session fixation and session hijacking vulnerabilities</li>
                        <li>Verify identity verification controls are in place</li>
                        {% endif %}
                        {% if 'Tampering' in threat.impactedSecObj %}
                        <li>Attempt to modify data in transit (man-in-the-middle)</li>
                        <li>Test input validation by submitting malformed data</li>
                        <li>Verify data integrity checks are enforced</li>
                        {% endif %}
                        {% if 'Repudiation' in threat.impactedSecObj %}
                        <li>Verify comprehensive audit logging is enabled</li>
                        <li>Test log integrity and tampering protection</li>
                        <li>Confirm non-repudiation mechanisms are in place</li>
                        {% endif %}
                        {% if 'Information Disclosure' in threat.impactedSecObj %}
                        <li>Test for sensitive data exposure in responses/errors</li>
                        <li>Verify encryption is used for data at rest and in transit</li>
                        <li>Check for information leakage in headers and metadata</li>
                        {% endif %}
                        {% if 'Denial of Service' in threat.impactedSecObj %}
                        <li>Test rate limiting and throttling controls</li>
                        <li>Verify resource exhaustion protection</li>
                        <li>Test failover and recovery mechanisms</li>
                        {% endif %}
                        {% if 'Elevation of Privilege' in threat.impactedSecObj %}
                        <li>Test access controls with different user roles</li>
                        <li>Attempt privilege escalation through parameter manipulation</li>
                        <li>Verify least privilege principle is enforced</li>
                        {% endif %}
                        <li>Document findings and evidence</li>
                        <li>Verify mitigations are effective against the threat</li>
                    </ol>
                    {% endif %}
                </div>
                
                {% if threat.testScripts %}
                <div class="test-scripts-section">
                    <h5 style="margin-bottom: 10px;">üíª Test Scripts</h5>
                    {% for script in threat.testScripts %}
                    <div class="test-script">
                        <div class="test-script-header">
                            <span class="test-script-language">{{ script.language }}</span>
                            <button class="test-script-copy no-print" onclick="copyTestScript(this, '{{ threat.ID }}_{{ loop.index }}')">üìã Copy</button>
                        </div>
                        {% if script.description %}
                        <div class="test-script-description">{{ script.description }}</div>
                        {% endif %}
                        <pre><code id="script-{{ threat.ID }}_{{ loop.index }}">{{ script.code }}</code></pre>
                        {% if script.requirements %}
                        <div class="test-script-requirements">
                            <strong>Requirements:</strong> {{ script.requirements | join(', ') }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="test-expected">
                    <h5>‚úì Expected Results</h5>
                    <ul style="margin: 0; padding-left: 20px;">
                        <li>Attack attempts should be blocked or detected</li>
                        <li>Security controls should function as designed</li>
                        <li>No sensitive information should be exposed</li>
                        {% if threat.countermeasures %}
                        {% for cm in threat.countermeasures %}
                        <li>{{ cm.mitigation }} should be effective</li>
                        {% endfor %}
                        {% endif %}
                    </ul>
                </div>
                
                <div class="test-tools">
                    {% if threat.testTools %}
                        {% for tool in threat.testTools %}
                        <span class="test-tool-tag">{{ tool }}</span>
                        {% endfor %}
                    {% else %}
                    <span class="test-tool-tag">Burp Suite</span>
                    <span class="test-tool-tag">OWASP ZAP</span>
                    {% if 'Spoofing' in threat.impactedSecObj or 'Elevation of Privilege' in threat.impactedSecObj %}
                    <span class="test-tool-tag">Hydra</span>
                    {% endif %}
                    {% if 'Information Disclosure' in threat.impactedSecObj %}
                    <span class="test-tool-tag">Nmap</span>
                    <span class="test-tool-tag">Nikto</span>
                    {% endif %}
                    {% if 'Denial of Service' in threat.impactedSecObj %}
                    <span class="test-tool-tag">Slowloris</span>
                    {% endif %}
                    {% if 'Tampering' in threat.impactedSecObj %}
                    <span class="test-tool-tag">SQLMap</span>
                    {% endif %}
                    {% endif %}
                </div>
                
                <div class="test-notes no-print">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px;">üìù Test Notes</label>
                    <textarea placeholder="Document test findings, evidence, and observations here..."></textarea>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% if not model.threats %}
        <div class="no-threats-message">
            <p>No threats identified - no test cases generated.</p>
        </div>
        {% endif %}
    </section>

        <!-- Footer -->
        <footer class="footer">
            <p>Generated by Threat Model Tool | {{ generation_timestamp }}</p>
            <p>{{ model.meta.title }} | {{ model.meta.modelId }} v{{ model.meta.version }}</p>
        </footer>
    </main>

    <script>
        // ========== PRINT/PDF MODE FUNCTIONALITY ==========
        function togglePrintMode() {
            const body = document.body;
            const toggleBtn = document.getElementById('printModeToggle');
            const isPrintMode = body.classList.toggle('print-mode');
            
            if (isPrintMode) {
                // Entering print mode
                toggleBtn.classList.add('active');
                toggleBtn.querySelector('span').textContent = 'Exit Print Mode';
                
                // Reset all diagram transforms for static viewing
                document.querySelectorAll('.diagram-canvas').forEach(canvas => {
                    canvas.style.transform = 'none';
                });
                
                // Scroll to top
                window.scrollTo(0, 0);
                
                // Store the current scroll position for restoration
                sessionStorage.setItem('scrollPosBeforePrint', window.scrollY);
            } else {
                // Exiting print mode
                toggleBtn.classList.remove('active');
                toggleBtn.querySelector('span').textContent = 'Print Mode';
                
                // Restore scroll position if available
                const savedPos = sessionStorage.getItem('scrollPosBeforePrint');
                if (savedPos) {
                    window.scrollTo(0, parseInt(savedPos));
                }
            }
        }
        
        // Keyboard shortcut: Ctrl+P for print mode, Escape to exit
        document.addEventListener('keydown', function(e) {
            // Escape to exit print mode
            if (e.key === 'Escape' && document.body.classList.contains('print-mode')) {
                togglePrintMode();
            }
            // Ctrl+Shift+P to toggle print mode (avoid conflict with browser print)
            if (e.ctrlKey && e.shiftKey && e.key === 'P') {
                e.preventDefault();
                togglePrintMode();
            }
        });
        
        // Check URL parameter for print mode
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('print') === 'true' || urlParams.get('pdf') === 'true') {
                togglePrintMode();
            }
            renderMermaidDiagrams();
        });

        // ========== END PRINT/PDF MODE ==========

        // Mermaid initialization with high-quality rendering for horizontal layouts
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            maxTextSize: 100000,
            fontSize: 13,
            flowchart: { 
                useMaxWidth: true, 
                htmlLabels: true,
                rankSpacing: 50,
                nodeSpacing: 30,
                curve: 'basis',
                defaultRenderer: 'dagre-wrapper',
                wrappingWidth: 300,
                padding: 10,
                diagramPadding: 8
            },
            themeVariables: {
                fontSize: '13px',
                fontFamily: 'Arial, sans-serif',
                primaryColor: '#3498db',
                primaryTextColor: '#fff',
                primaryBorderColor: '#2980b9',
                lineColor: '#7f8c8d',
                secondaryColor: '#ecf0f1',
                tertiaryColor: '#f8f9fa'
            }
        });

        async function renderMermaidDiagrams() {
            const diagrams = Array.from(document.querySelectorAll('.mermaid'));
            if (!diagrams.length) {
                return;
            }
            if (!window.mermaid) {
                diagrams.forEach(el => {
                    el.innerHTML = '<div style="padding:12px; background:#fff3cd; color:#856404; border:1px solid #ffeeba; border-radius:6px; font-size:0.9rem;">Mermaid is not available. Please ensure the Mermaid CDN is reachable.</div>';
                });
                return;
            }

            for (const el of diagrams) {
                const source = el.textContent.trim();
                if (!source) {
                    el.innerHTML = '<div style="padding:12px; background:#fff3cd; color:#856404; border:1px solid #ffeeba; border-radius:6px; font-size:0.9rem;">Mermaid source was empty.</div>';
                    continue;
                }

                // Generate unique ID for Mermaid render (must be unique per render call)
                const baseId = el.getAttribute('data-diagram-id') || 'mermaid';
                const diagramId = `${baseId}-${Date.now()}-${Math.random().toString(36).slice(2)}`;
                try {
                    // Clear original text before rendering
                    el.innerHTML = '';

                    // Mermaid v10+ returns a Promise from render
                    const renderResult = mermaid.render(diagramId, source);
                    const { svg, bindFunctions } = (renderResult && typeof renderResult.then === 'function')
                        ? await renderResult
                        : renderResult;

                    el.innerHTML = svg;
                    if (typeof bindFunctions === 'function') {
                        bindFunctions(el);
                    }
                } catch (err) {
                    console.error('Mermaid render error:', err);
                    const pre = document.createElement('pre');
                    pre.style.whiteSpace = 'pre-wrap';
                    pre.style.background = '#fff3cd';
                    pre.style.color = '#856404';
                    pre.style.border = '1px solid #ffeeba';
                    pre.style.borderRadius = '6px';
                    pre.style.padding = '12px';
                    pre.textContent = 'Mermaid failed to render this diagram. Please check the diagram syntax in the source.';
                    el.innerHTML = '';
                    el.appendChild(pre);
                }
            }
        }
        
        // PlantUML rendering using online service
        // Store PUML source without HTML escaping (using tojson for proper JS string escaping)
        const pumlComponentSource = {{ dfd_plantuml | tojson | safe }};
        const pumlSequenceSource = {{ dfd_plantuml_sequence | tojson | safe }};
        
        console.log('PUML Component Source loaded:', pumlComponentSource ? pumlComponentSource.substring(0, 100) + '...' : 'empty');
        console.log('PUML Sequence Source loaded:', pumlSequenceSource ? pumlSequenceSource.substring(0, 100) + '...' : 'empty');
        
        function encodePlantUML(puml) {
            // PlantUML text encoding (similar to base64 but custom)
            function encode64(data) {
                let r = "";
                for (let i = 0; i < data.length; i += 3) {
                    if (i + 2 === data.length) {
                        r += append3bytes(data[i], data[i+1], 0);
                    } else if (i + 1 === data.length) {
                        r += append3bytes(data[i], 0, 0);
                    } else {
                        r += append3bytes(data[i], data[i+1], data[i+2]);
                    }
                }
                return r;
            }
            
            function append3bytes(b1, b2, b3) {
                let c1 = b1 >> 2;
                let c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
                let c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
                let c4 = b3 & 0x3F;
                let r = "";
                r += encode6bit(c1 & 0x3F);
                r += encode6bit(c2 & 0x3F);
                r += encode6bit(c3 & 0x3F);
                r += encode6bit(c4 & 0x3F);
                return r;
            }
            
            function encode6bit(b) {
                if (b < 10) return String.fromCharCode(48 + b);
                b -= 10;
                if (b < 26) return String.fromCharCode(65 + b);
                b -= 26;
                if (b < 26) return String.fromCharCode(97 + b);
                b -= 26;
                if (b === 0) return '-';
                if (b === 1) return '_';
                return '?';
            }
            
            // properly handle encoding for pako 2.x which uses Uint8Array
            const encoder = new TextEncoder();
            const data = encoder.encode(puml);
            
            if (window.pako && window.pako.deflateRaw) {
                try {
                    const deflated = window.pako.deflateRaw(data); // returns Uint8Array
                    return encode64(deflated);
                } catch(e) {
                    console.error('Pako error:', e);
                    return "";
                }
            } else {
                console.warn('Pako not loaded, cannot compress PlantUML source.');
                return "";
            }
        }
        
        // Load pako for deflate compression
        function loadPako(callback) {
            if (window.pako) {
                callback();
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js';
            script.onload = callback;
            script.onerror = function() {
                console.warn('Pako not loaded, PlantUML diagrams may not render');
                callback();
            };
            document.head.appendChild(script);
        }
        
        function renderPlantUMLDiagrams() {
            console.log('Starting PlantUML rendering...');
            loadPako(function() {
                console.log('Pako loaded:', !!window.pako);
                
                // Render component diagram
                if (pumlComponentSource && pumlComponentSource.trim().length > 0) {
                    console.log('Rendering component diagram...');
                    try {
                        const encodedComponent = encodePlantUML(pumlComponentSource);
                        const url = 'https://www.plantuml.com/plantuml/svg/' + encodedComponent;
                        console.log('Component diagram URL:', url.substring(0, 100) + '...');
                        
                        const componentImg = document.getElementById('puml-component-img');
                        if (componentImg) {
                            componentImg.src = url;
                            componentImg.onload = function() {
                                console.log('Component diagram loaded successfully');
                            };
                            componentImg.onerror = function(e) {
                                console.error('Failed to load component diagram:', e);
                                this.alt = 'Failed to render PlantUML diagram. Try copying the source and using a local PlantUML renderer.';
                                this.style.background = '#fff3cd';
                                this.style.padding = '20px';
                                this.style.color = '#856404';
                            };
                        }
                    } catch (e) {
                        console.error('Error encoding component PUML:', e);
                    }
                } else {
                    console.warn('No component PUML source available');
                }
                
                // Render sequence diagram
                if (pumlSequenceSource && pumlSequenceSource.trim().length > 0) {
                    console.log('Rendering sequence diagram...');
                    try {
                        const encodedSequence = encodePlantUML(pumlSequenceSource);
                        const url = 'https://www.plantuml.com/plantuml/svg/' + encodedSequence;
                        console.log('Sequence diagram URL:', url.substring(0, 100) + '...');
                        
                        const sequenceImg = document.getElementById('puml-sequence-img');
                        if (sequenceImg) {
                            sequenceImg.src = url;
                            sequenceImg.onload = function() {
                                console.log('Sequence diagram loaded successfully');
                            };
                            sequenceImg.onerror = function(e) {
                                console.error('Failed to load sequence diagram:', e);
                                this.alt = 'Failed to render PlantUML diagram. Try copying the source and using a local PlantUML renderer.';
                                this.style.background = '#fff3cd';
                                this.style.padding = '20px';
                                this.style.color = '#856404';
                            };
                        }
                    } catch (e) {
                        console.error('Error encoding sequence PUML:', e);
                    }
                } else {
                    console.warn('No sequence PUML source available');
                }
            });
        }
        
        // Tab switching for PlantUML views
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Update tab content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');

                // Refit diagrams in the active tab to maximize zoom
                const activeContent = document.getElementById(tabId);
                if (activeContent) {
                    const diagrams = activeContent.querySelectorAll('.interactive-diagram');
                    diagrams.forEach(diagram => {
                        const controller = diagram._diagramController;
                        if (controller && typeof controller.fitToView === 'function') {
                            setTimeout(() => controller.fitToView(), 50);
                        }
                    });
                }
            });
        });
        
        // Source tab switching
        document.querySelectorAll('.source-tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const sourceId = this.dataset.source;
                
                // Update source tab buttons
                document.querySelectorAll('.source-tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Update source content
                document.querySelectorAll('.source-content').forEach(c => c.classList.remove('active'));
                document.getElementById('source-' + sourceId).classList.add('active');
            });
        });
        
        // Copy PlantUML source to clipboard
        function copyPumlSource(type) {
            const source = type === 'component' ? pumlComponentSource : pumlSequenceSource;
            navigator.clipboard.writeText(source).then(function() {
                alert('PlantUML source copied to clipboard!');
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
                // Fallback: select text
                const sourceEl = document.querySelector('#source-' + type + ' code');
                if (sourceEl) {
                    const range = document.createRange();
                    range.selectNode(sourceEl);
                    window.getSelection().removeAllRanges();
                    window.getSelection().addRange(range);
                }
            });
        }
        
        // Initialize PlantUML rendering on page load
        document.addEventListener('DOMContentLoaded', renderPlantUMLDiagrams);
        
        // ========== SECURITY TESTING FUNCTIONALITY ==========
        function toggleTestCase(header) {
            const body = header.nextElementSibling;
            const isVisible = body.style.display !== 'none';
            body.style.display = isVisible ? 'none' : 'block';
        }
        
        function copyTestScript(button, scriptId) {
            const codeElement = document.getElementById('script-' + scriptId);
            const code = codeElement.textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy script to clipboard');
            });
        }
        
        function updateTestStatus(select, threatId) {
            const newStatus = select.value;
            const card = document.getElementById('test-' + threatId);
            const oldStatus = card.dataset.testStatus;
            
            // Update card status
            card.dataset.testStatus = newStatus;
            
            // Update select styling
            select.className = 'test-status-select ' + newStatus + ' no-print';
            
            // Update counters
            updateTestingCounters(oldStatus, newStatus);
        }
        
        function updateTestingCounters(oldStatus, newStatus) {
            const passedEl = document.getElementById('test-passed');
            const failedEl = document.getElementById('test-failed');
            const pendingEl = document.getElementById('test-pending');
            
            let passed = parseInt(passedEl.textContent);
            let failed = parseInt(failedEl.textContent);
            let pending = parseInt(pendingEl.textContent);
            
            // Decrement old status count
            if (oldStatus === 'passed') passed--;
            else if (oldStatus === 'failed') failed--;
            else if (oldStatus === 'not-tested' || oldStatus === 'in-progress') pending--;
            
            // Increment new status count
            if (newStatus === 'passed') passed++;
            else if (newStatus === 'failed') failed++;
            else if (newStatus === 'not-tested' || newStatus === 'in-progress') pending++;
            
            passedEl.textContent = passed;
            failedEl.textContent = failed;
            pendingEl.textContent = pending;
        }
        
        // Sidebar navigation toggle
        function toggleSection(header) {
            const section = header.closest('.nav-section');
            section.classList.toggle('expanded');
        }
        
        // Threat group accordion toggle (only one open at a time)
        function toggleThreatGroup(header) {
            const group = header.closest('.nav-threat-group');
            const isExpanded = group.classList.contains('expanded');
            
            // Close all other threat groups
            document.querySelectorAll('.nav-threat-group.expanded').forEach(g => {
                g.classList.remove('expanded');
            });
            
            // Toggle clicked group (open if it was closed)
            if (!isExpanded) {
                group.classList.add('expanded');
            }
        }
        
        // Highlight current section on scroll
        document.addEventListener('DOMContentLoaded', function() {
            const navItems = document.querySelectorAll('.nav-item, .nav-threat-item');
            const sections = document.querySelectorAll('section[id], .threat-card[id], h3[id]');
            
            function updateActiveNav() {
                let currentSection = '';
                const scrollPos = window.scrollY + 100;
                
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    if (scrollPos >= sectionTop) {
                        currentSection = section.getAttribute('id');
                    }
                });
                
                navItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.getAttribute('href') === '#' + currentSection) {
                        item.classList.add('active');
                        // Auto-expand the threat group if a threat is active
                        const group = item.closest('.nav-threat-group');
                        if (group && !group.classList.contains('expanded')) {
                            document.querySelectorAll('.nav-threat-group.expanded').forEach(g => {
                                g.classList.remove('expanded');
                            });
                            group.classList.add('expanded');
                        }
                    }
                });
            }
            
            window.addEventListener('scroll', updateActiveNav);
            updateActiveNav();
            
            // Smooth scroll for nav items
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });
        });
    </script>
    
    {{ diagram_scripts() }}
</body>
</html>